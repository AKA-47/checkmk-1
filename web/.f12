#!/bin/bash
set -e

SITE=${SITE:-$(cat ../.site 2>/dev/null || true)}
SITE=${SITE:-$(omd sites --bare | head -n 1)}
ROOT=/omd/sites/$SITE

sudo rsync \
    --exclude "*cmc.py" \
    --exclude "*omd_configuration.py" \
    -varx htdocs plugins $ROOT/share/check_mk/web/
#    --delete \
echo "$C files copied"

if [ "$KILL_SITE_APACHE" -eq "1" ]; then
    echo "KILLING site apache of $SITE"
    sudo killall -9 -u $SITE apache2 || true
fi

if [ -z $ONLY_COPY ]; then
    if [ "$SITE" != - ] ; then
        sudo omd restart $SITE apache
    fi
fi

# Per Default wird geguckt, ob die *_min.js-Dateien älter sind, als
# die Original-Dateien. Wenn ja, dann werden sie neu erstellt.
sudo make DESTDIR=$ROOT/share/check_mk -C .. install-minified-js
# Wenn man ohne die min-Dateien entwickeln will, kann man das hier
# auskommentieren. Dies räumt dann auch die Dateien weg, die
# schon in der original-Installation vom OMD vorhanden waren.
#sudo rm -f $ROOT/share/check_mk/web/htdocs/js/*_min.js

# Gecache PNP-Schablonen entfernen
sudo rm -f $ROOT/var/check_mk/pnp_template_cache/*
