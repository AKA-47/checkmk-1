#!/bin/bash
# The script creates a chroot based on a current ubuntu version
# and installs all dependencies needed to build the windows agent.

set -e

DISTRO=zesty
MIRROR=http://de.archive.ubuntu.com/ubuntu

export HOSTNAME=cmk-windows-agent-chroot
export LC_ALL=en_US.UTF-8 LANGUAGE=en_US.UTF-8 LANG=en_US.UTF-8

BASE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MNT=$BASE/chroot

cleanup_chroot() {
    PIDS=$(lsof -Fp $MNT 2>/dev/null | cut -dp -f2)
    [ -n "$PIDS" ] && kill -9 $PIDS 2>&1

    [ -e $MNT/dev/pts/ptmx ] && umount $MNT/dev/pts && sleep 2
    [ -e $MNT/dev/sda ] && umount $MNT/dev && sleep 2
    [ -e $MNT/proc/self ] && umount $MNT/proc && sleep 2

    if mount | grep $MNT >/dev/null; then
        echo "Error: There are still mounts below $MNT. Terminating."
        exit 1
    fi
}

if [ "$(id -u)" != "0" ]; then
    echo "Sorry, you are not root. Change or execute this script with sudo."
    exit 1
fi

unset LANG

echo "+ CLEANING UP CHROOT"
cleanup_chroot

# chroot leer machen
rm -rf $MNT/*

echo "+ INSTALLING SYSTEM"

# TODO: Would use --force-check-gpg, but not supported on wheezy (root server)
debootstrap \
    --components=main,universe \
    --include=linux-base,locales,mingw-w64,wine-stable \
    --arch amd64 $DISTRO $MNT $MIRROR

# Need to be installed for installation.
cat <<EOF > $MNT/etc/fstab
# created by make-chroot
/dev/sda1 / ext2 rw,noatime,nodiratime,errors=continue 0 1
EOF

# Nun ein kleiner Hack um zu verhindern, dass beim Installieren der Pakete
# die Daemonen der Pakete gestartet werden. Ist nicht dramatisch, erzeugt
# aber doofe Fehlermeldungen.
echo exit 101 > $MNT/usr/sbin/policy-rc.d
chmod +x $MNT/usr/sbin/policy-rc.d

cp /etc/resolv.conf $MNT/etc/resolv.conf

if [ ! -e $MNT/bin/hostname.bin ] ; then
    mv $MNT/bin/hostname{,.bin}
fi
cat <<EOF > $MNT/bin/hostname
echo $HOSTNAME
EOF
chmod +x $MNT/bin/hostname

# Uses debian_chroot, but use it for all distros!
#debian_chroot=\$(hostname)
cat <<EOF > $MNT/root/.bashrc
debian_chroot=$(hostname)
PS1='\${debian_chroot:+(\$debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\\$ '
PS1="\[\e]0;\${debian_chroot:+(\$debian_chroot)}\u@\h: \w\a\]\$PS1"
EOF

mkdir $MNT/build

echo "+ CLEANING UP"

# Raeume apt-cache auf
ls $MNT/var/cache/apt/archives/*.deb >/dev/null 2>&1 \
    && rm $MNT/var/cache/apt/archives/*.deb 2>&1 || true

# Alle Prozesse aus dem chroot killen
cleanup_chroot

echo "+ FINISHED!"
