#!/bin/bash
# Build Windows agent with GNU autotools.
#
# Options:
#          -jN  where N is the number of parallel build jobs
#          (for usage, see 'man make'). Default: half of available CPU cores.
# Parameters:
#          Possible make targets. By default, a parallel build and
#          install-strip (non-debug) is done and an msi installer produced.
#
# Requires the environment variable CHROOT_BUILD_DIR to be set.

# Ensure that CHROOT_BUILD_DIR is set.
[[ -z $CHROOT_BUILD_DIR ]] && exit 1

. $CHROOT_BUILD_DIR/agents/windows/build.sh

parse-args "$@"
cd $CHROOT_BUILD_DIR/agents/windows
autoreconf --install

# Build 32 and 64 bit in parallel, wait for child processes to terminate.
for arch in 32 64 ; do
    build $arch &
done
wait

# If no special targets given, produce msi installer as post-install step.
if [[ -z "$targets" ]] ; then
    VERSION=$(grep PACKAGE_VERSION= configure | sed "s/.*\x27\(.*\)\x27/\1/g")
    cd msibuild
    make BUILD_VERSION=$(cat ../build_version) CHECK_MK_VERSION=$VERSION
    chmod +x check_mk_agent.msi
    mv check_mk_agent.msi ..
    cd -
fi
