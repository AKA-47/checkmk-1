#!/bin/bash
set -e

ME="cmk/base/plugins/.f12"

SITE=${SITE:-$(until [ $PWD == / ]; do if [ -e .site ]; then
    cat .site
    break
else cd ..; fi; done)}
SITE=${SITE:-$(omd sites --bare | head -n 1)}
ROOT=/omd/sites/$SITE

echo "[$ME] Update site $SITE..."

echo "[$ME] Copy CRE files..."
sudo rsync \
    --exclude="*.pyc" \
    --exclude="flycheck*" \
    -a * $ROOT/lib/python3/cmk/base/plugins

# Ensure cmk.base[.cee] is a namespace package
sudo rm -f \
    "$ROOT/lib/python3/cmk/base/plugins/__init__.py" \
    "$ROOT/lib/python3/cmk/base/plugins/__init__.pyc" \
    "$ROOT/lib/python3/cmk/base/plugins/agent_based/__init__.py" \
    "$ROOT/lib/python3/cmk/base/plugins/agent_based/__init__.pyc" \
    "$ROOT/lib/python3/cmk/base/plugins/agent_based/utils/__init__.py" \
    "$ROOT/lib/python3/cmk/base/plugins/agent_based/utils/__init__.pyc"

if [ -z "$ONLY_COPY" ]; then
    sudo $ROOT/bin/python3 -m compileall -qq $ROOT/lib/python3/cmk/base/plugins
fi
